<fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
    <legend>下单用户信息录入(含<span style="color: red">*</span>为必填项)</legend>
</fieldset>
<form class="layui-form layui-form-pane" lay-filter="example" action="">
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label"><span style="color: red">*</span>用户名</label>
            <div class="layui-input-inline">
                <input type="text" id="username" name="username" lay-verify="required" placeholder="请输入"
                       autocomplete="on" class="layui-input" list="userNameList" onkeyup="searchUserName()">
                <datalist id="userNameList"></datalist>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">联系电话</label>
            <div class="layui-input-inline">
                <input type="text" id="phoneNumber" name="phoneNumber" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"><span style="color: red">*</span>订单号</label>
        <div class="layui-input-inline">
            <input type="text" id="orderId" name="orderId" lay-verify="required" placeholder="请输入" autocomplete="off"
                   class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label"><span style="color: red">*</span>日期选择</label>
            <div class="layui-input-block">
                <input type="text" name="orderDate" id="orderDate" lay-verify="required" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">下单商品</label>
        <div class="layui-input-block" id="goodDiv">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">关系</label>
        <div class="layui-input-block" id="relationDiv">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">物流</label>
        <div class="layui-input-block">
            <input type="checkbox" id="wuliuSwitch" name="wuliuSwitch" lay-skin="switch" lay-text="已到|未到">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">评价</label>
        <div class="layui-input-block">
            <input type="checkbox" id="commentSwitch" name="commentSwitch" lay-skin="switch" lay-text="已评|未评">
        </div>
    </div>
    <div class="layui-form-item">
        <button type="submit" class="layui-btn" lay-submit="" lay-filter="submitBtn">立即提交</button>
    </div>
</form>
<script>
    var nameList = new Array();

    function searchUserName() {
        $("#userNameList").empty();
        var username = $('#username').val();
        for (var i = 0; i < nameList.length; ++i) {
            if (username != "" && nameList[i].match(username + ".*") != null) {
                var option = "<option>" + nameList[i] + "</option>";
                $("#userNameList").append(option);
            }
        }
    }

    function init() {
        $.ajax({
            url: '/api/dictionary/GetDicTypeData'
            , contentType: "application/json;charset=UTF-8"
            , type: 'get'
            , success: function (data) {
                var goodCheckBoxHtml = "";
                var relationCheckBoxHtml = "";
                for (var i = 0; i < data.length; i++) {
                    if (data[i].type === "good") {
                        goodCheckBoxHtml += '<input type="checkbox" id="good" name="good" title="' + data[i].keyName + '" value="' + data[i].dcisValue + '">'
                    } else if (data[i].type === "relation") {
                        relationCheckBoxHtml += '<input type="radio" id="relation" name="relation" value="' + data[i].dcisValue + '" title="' + data[i].keyDesc + '" checked="' + (data[i].dcisValue === 1 ? "checked" : "") + '">';
                    }
                }
                $('#goodDiv').html(goodCheckBoxHtml);
                $('#relationDiv').html(relationCheckBoxHtml);
                layui.form.render();
            },
            error: function (error) {
                console.log(error)
            }
        });
        $.ajax({
            url: "/api/user/queryUserNameList"
            , success: function (result) {
                if (result.length > 0) {
                    for (var i = 0; i < result.length; i++) {
                        nameList.push(result[i]);
                    }
                } else {
                    console.log("未找到匹配的值")
                }
            },
            error: function (error) {
                console.log(error)
            }
        });
    }

    function SetUserNameValue(userName) {
        $('#username').val(userName);
    }

    init();

    layui.use(['form', 'layedit', 'laydate'], function () {
        var form = layui.form
            , layer = layui.layer
            , laydate = layui.laydate;
        form.render();
        //日期
        laydate.render({
            elem: '#orderDate'
        });

        //监听提交
        form.on('submit(submitBtn)', function (data) {
            var goods = '';
            $("input:checkbox[name='good']:checked").each(function (i) {
                if (0 === i) {
                    goods = $(this).val();
                } else {
                    goods += ("," + $(this).val());
                }
            });
            var userForm = {
                "userName": $('#username').val(),
                "phoneNumber": $('#phoneNumber').val(),
                "orderId": $('#orderId').val(),
                "orderDate": $('#orderDate').val(),
                "good": goods,
                "relation": $('#relation').val(),
                "wuliuSwitch": $('#wuliuSwitch').is(':checked') ? 1 : 0,
                "commentSwitch": $('#commentSwitch').is(':checked') ? 1 : 0
            }
            $.ajax({
                url: '/api/addUserMessage'
                , contentType: "application/json;charset=UTF-8"
                , type: 'post'
                , dataType: 'json'
                , data: JSON.stringify(userForm)
                , success: function (result) {
                    if (result) {
                        $("#username").val('');
                        $('#phoneNumber').val('');
                        $('#orderId').val('');
                        layer.msg("添加成功");
                    } else {
                        layer.msg("添加失败");
                    }
                },
                error: function (error) {
                    console.log(error)
                }
            });
            return false;//禁止跳转，否则会提交两次，且页面会刷新
        });
    });
</script>